{% load static %}
<style>
    /* file browser page */
    .folder-browser-page {
        display: none;
        height: 100%;
    }

    .browserFilesContent {
        overflow-y: scroll;
        overflow-x: hidden;
        height: 100vh;
    }

    .folder-toolbar-navigator {
        padding-left: 20px;
    }

    .folder-toolbar-navigator>i {
        color: gray;
    }
    .folder-toolbar-navigator>span{
        color: gray;
    }
    .slash{
        margin-left: 5px;
        margin-right: 5px;
        color: gray;
    }
    .directory-name:hover{
        text-decoration: underline;
    }

    .slash{
        text-decoration: none;
    }

    .upload-file{
        position: absolute;
        top: 15px;
        right: 30px;
        color: gray;
        transition: all 0.2s ease-in;
    }


    .folder-categorizer {
        margin-top: 30px;
        display: grid;
        padding-left: 20px;
        grid-template-columns: 10% 29.3% 20% 30% 10%;
    }


    .categorizer-text {
        margin-top: 2px;
        font-size: small;
        color: gray;
    }

    .separator {
        border-bottom: solid 1px rgba(235, 235, 235, 0.685);
        margin-left: -20px;
        margin-top: 20px;
    }

    .folder-browser-page {
        margin-right: 1.5%;
    }

    .folder-categorizer.item{
        margin-top: 0;
        padding-left: 20px;
        padding-top: 10px;
        padding-bottom: 10px;
        grid-template-columns: 10% 30% 20% 30% 10%;
        border-bottom: solid 1px rgba(235, 235, 235, 0.685);
        transition: all 0.1s ease;
    }


    .folder-categorizer.selected {
        opacity: 0.8;
        background-color: rgba(128, 128, 128, 0.089);
    }

    .categorizer-text>i{
        margin-right: 10px;
        color: rgb(108, 219, 177);
    }

    .folder-categorizer.item:hover{
        background-color: rgba(142, 178, 226, 0.137);
    }

    .file-menu-modal {
        background-color: white;
        height: auto;
        width: 220px;
        z-index: 101;
        position: fixed;
        top: 190px;
        left: 400px;
        border-radius: 6px;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        opacity: 0;
        visibility: hidden;
    }

    .file-menu-modal.show{
        opacity: 1;
        visibility: visible;
    }

    .file-menu-modal-item{
        font-size: small;
        color: gray;
        padding: 10px;
        padding-left: 20px;
    }

    .file-menu-modal-item:hover{
        background-color: rgba(243, 243, 243, 0.795);
    }

    .separator {
        margin:0;
    }
    .folder-toolbar {
        height: 100%;
    }
    .name-folder-modal-subtext {
        margin-top: 10px;
        font-size: x-small;
    }

    /* name folder modal  */
    .name-folder-modal {
        position: fixed;
        z-index: 102;
        top: 50%;
        left: 50%;
        border-radius: 6px;
        transform: translate(-50%,-50%);
        padding: 20px;
        background-color: white;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        visibility: hidden;
        opacity: 0;
        transition: all 0.1s ease-in;
    }

    .name-folder-modal.show{
        visibility: visible;
        opacity: 1;
        transform: translate(-50%,-50%);
    }

    .name-folder-modal-header {
        font-size: small;
    }

    .create-folder-button {
        padding: 15px 20px;
        font-size: x-small;
        background-color: #8594E3;
        color: white;
        text-align: center;
        margin-top: 10px;
        border-radius: 6px;
        width: 80px;
        margin-left: -10px;
        transition: all 0.2s ease-in;
    }

    .create-folder-button:hover {
        transform: scale(1.02);
    }

    .cancel-folder-button {
        padding: 15px 20px;
        font-size: x-small;
        background-color: white;
        border: solid 1px gray;
        text-align: center;
        margin-top: 10px;
        border-radius: 6px;
        width: 80px;
    }

    .folder-namer-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
    }

    @media only screen and (max-width: 600px) {
        .folder-categorizer.item {
            grid-template-columns: 20% 90% ;
        }

        .folder-categorizer {
            grid-template-columns: 20% 90% ;
        }

        .hide-mobile {
            display: none;
        }
    }

    /* file access control modal */
    .file-access-control-modal{
        position: fixed;
        bottom: 0;
        right: 0;
        margin-left: 1%;
        margin-right: 1%;
        height: 0%;
        border-radius: 6px 6px 0px 0px;
        background-color: white;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        width: 95%;
        padding: 20px;
        visibility: hidden;
        transition:  all 0.1s ease-in;
        cursor: pointer;
    }

    .file-access-control-modal.show {
        height: 50%;
        visibility: visible;
    }

    .file-access-control-modal>.close {
        position: absolute;
        top: 15px;
        right: 15px;
        color: gray;
    }

    .file-access-control-modal>.header{
        font-size: small;
    }
    .file-access-control-modal>.subtext{
        font-size: 9pt;
        margin-top: 4px;
        opacity: 0.9;
    }
    .file-access-control-modal>.body{
        display: grid;
        grid-template-columns: 20% 80%;
        opacity: 0.9;
    }

    .file-access-control-modal>.body>.left{
        height: 100vh;
        border-right: solid 1px rgba(235, 235, 235, 0.753);
    }

    .file-access-control-modal>.body>.right{
        padding: none;
    }

    .sm {
        font-size: 9pt;
    }

    /* account keys */
    .delete-account-key {
        margin-left: 20px;
        visibility: hidden;
        opacity: 0;
        transition: all 0.2s ease-in;
    }

    .add-account-key {
        opacity: 0.8;
        margin-left: 20px;
    }

    .delete-account-key.show{
        opacity: 0.8;
        visibility: visible;
    }

    /*  delete button multiple files */

    .delete-button-files {
        margin-right: 20px;
        color: gray;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease-in;
    }

    .delete-button-files.show {
        opacity: 1;
        visibility: visible;
    }


</style>

<div class="folder-browser-page">  
    <div id="browserLoader" class="pageLoader" style="transform: scale(0.2);">
         <div class="loader-console"></div>
    </div>
    <div class="folder-toolbar" >
        <div  class="folder-toolbar-navigator">
             <i class="fas fa-home" onclick="goHome()"></i><span id="dirMapper"><!-- mapping elements here --> </span>
        </div>
        <!-- upload and delete-->
        <div class="upload-file">
             <i class="delete-button-files"><i class="fas fa-trash" onclick="deleteSelectedFiles()"></i></i> <!-- upload--> <i class="fas fa-upload" onclick="uploadFile()"></i>
        </div>
        <!-- folders-->
        <div class="folder-categorizer">
            <div class=""><input id="selectUnselectAllFiles" type="checkbox" onclick="selectUnselectAllFiles(this)"></div>
            <div class="categorizer-text">Name</div>
            <div class="categorizer-text hide-mobile ">Size</div>
            <div class="categorizer-text hide-mobile ">Modified</div>
        </div>
        <!-- separator -->
        <div class="separator"></div>
        <!-- files come in here-->
        <div id="browserFilesContent" class="browserFilesContent" onclick="removeAnyModal()" oncontextmenu="showOptionsModal(event)" >
    
        </div>

        <!-- rename folder modal  -->
        <div id="renameFolderModal" class="name-folder-modal">
            <div class="name-folder-modal-header">Rename</div>
            <div class="name-folder-modal-subtext">Enter new name</div>
            <div id="projectNameNew" class="input-frame" style="position: relative;">
                <input id="renameText" class="projects-modal-body-item plain-input no-anime" style="width: 280px;cursor: text;">
            </div>
            <div class="folder-namer-buttons">
                <div class="cancel-folder-button" onclick="hideRenameModal()" >
                    Cancel
                </div>
                <div id="createFolderButton" class="create-folder-button" onclick="sendRenameRequest()"> 
                    Rename
                </div>
            </div>
        </div>
       
        <!-- access control add account modal -->
        <!-- rename folder modal  -->
        <div id="accountKeyAddModal" class="name-folder-modal">
            <div class="name-folder-modal-header">Give key to account</div>
            <div class="name-folder-modal-subtext">Enter account id</div>
            <div id="projectNameNew" class="input-frame" style="position: relative;">
                <input id="accountKeyIDText" class="projects-modal-body-item plain-input no-anime" style="width: 280px;cursor: text;">
            </div>
            <div class="folder-namer-buttons">
                <div class="cancel-folder-button" onclick="hideAddAccountKey()" >
                    Cancel
                </div>
                <div id="createFolderButton" class="create-folder-button" onclick=" giveKeyToAccountHTTP()"> 
                    Give Key
                </div>
            </div>
        </div>
        <!-- access control modal -->
        <div id="accessControlModal" class="file-access-control-modal">
            <!-- cancel -->
            <div class="close"><i class="fas fa-times" onclick="hideAccessControlModal()"></i></div>
            <!-- access control about section-->
            <div class="header">Access Control Panel</div>
            <div id="access-control-object-ownwer" class="subtext" style="margin-top: 20px;">Owner : rbryanben</div>
            <div id="access-control-object-ownwer" class="subtext">Owner Account Type : developer</div>
            <div class="separator" style="margin-top: 20px;"></div>
            <!-- body-->
            <div class="body">
                <div class="left">
                    <div class="access-control-detail div-flex start" style="margin-top: 20px;">
                        <input id="allowAllUsersWriteAccessControl" type="checkbox" onclick="updateObjectAccessControl()"><span class="sm">allowAllUsersWrite</span>
                    </div>
                    <div class="access-control-detail div-flex start">
                        <input id="allowAllUsersReadAccessControl" type="checkbox" onclick="updateObjectAccessControl()"><span class="sm">allowAllUsersRead</span>
                    </div>
                    <div class="access-control-detail div-flex start">
                        <input id="allowKeyUsersWriteAccessControl" type="checkbox" onclick="updateObjectAccessControl()"><span class="sm">allowKeyUsersWrite</span>
                    </div>
                    <div class="access-control-detail div-flex start">
                        <input id="allowKeyUsersReadAccessControl" type="checkbox" onclick="updateObjectAccessControl()"><span class="sm">allowKeyUsersRead</span>
                    </div>
                </div>
                <div class="right">
                    <!-- top bar -->
                    <div class="sm" style="margin-top: 20px;padding-left: 20px;">Accounts with key <!-- add acccount --><span class="add-account-key"><i class="fas fa-plus" onclick="showAddAccountKey()"></i></span><!-- delete account--><span class="delete-account-key" id="deleteAccountKeyButton"><i class="fas fa-trash" onclick="deleteSelectedKeyAccounts()"></i></span></div> 
                    <!-- categorizer-->
                    <div class="folder-categorizer item" style="margin-top: 15px;">
                        <div class=""><input type="checkbox" id="allKeysSelector" onclick="selectAllAccountsWithKeys(this)"></div>
                        <div class="categorizer-text">
                            <!-- object type-->                 
                            Identifier</div>
                        <div class="categorizer-text hide-mobile ">Providers</div>
                        <div class="categorizer-text hide-mobile ">Obtained</div>
                    </div>
                    <div id="accessControlLoader" class="pageLoader"  style="transform: scale(0.2);top: 60%;">
                        <div class="loader-console"></div>
                   </div>
                    <!--items panel-->
                    <div id="accounts-with-key" class="accounts-with-key" style="overflow-y: scroll; overflow-x: hidden; min-height: 100px;">

                    </div>
                </div>
            </div>
        </div>
        <!-- name folder modal  -->
        <div id="nameFolderModal" class="name-folder-modal">
            <div class="name-folder-modal-header">Folder Name</div>
            <div class="name-folder-modal-subtext">Enter new folder name</div>
            <div id="projectNameNew" class="input-frame" style="position: relative;">
                <input id="newFolderName" class="projects-modal-body-item plain-input no-anime" style="width: 280px;cursor: text;">
            </div>
            <div class="folder-namer-buttons">
                <div class="cancel-folder-button" onclick="hideNameFolderModal()">
                    Cancel
                </div>
                <div id="createFolderButton" onclick="createNewFolder()" class="create-folder-button">
                    Create Folder
                </div>
            </div>
        </div>

        <!-- file menu modal-->
        <div class="file-menu-modal" id="fileOptionsModal">
            <div class="file-menu-modal-item" onclick="menuModalOpenClick()">
                Open
            </div>
            <div class="file-menu-modal-item" onclick="showRenameModal()">
                Rename
            </div>
            <div class="file-menu-modal-item" onclick="menuModalDeleteClick()">
                Delete
            </div>
            <div class="separator"></div>
            <div class="file-menu-modal-item hide-mobile" onclick="showAccessControlModal()">
                Access Control
            </div>
        </div>

        <!-- plain options -->
        <div class="file-menu-modal" id="browserOptionsModal">
            <div class="file-menu-modal-item" onclick="uploadFile()">
                Upload File
            </div>
            <div class="file-menu-modal-item" onclick="plainMenuNewFolderClick()">
                New Folder
            </div>
            <div class="file-menu-modal-item" onclick="reloadFiles()">
                Reload Index
            </div>
        </div>
     </div>
</div>

<script>
    var filesPageBrowser 

    /////////////////////////////////////////////////////////////classes and variables 
    
    //class indexObject
    let IndexObject = class {
        constructor(objectID,objectType,objectName,objectSize,objectCreated){
            this.objectID = objectID
            this.objectType = objectType
            this.objectName = objectName
            this.objectSize = objectSize
            this.objectCreated = objectCreated
        }
    }

    //directory object class
    let dirObject = class {
        constructor(folderID,name){
            this.folderID = folderID
            this.folderName = name
        }
    }

    //index object selected
    let indexObjectSelected = false

    //focused object variable, this could be a file or folder
    let focusedFile ;

    /// browser file objects handle right clicks
    let showingFolder = false

    ///browser navigation, used to track the current directory
    let browserNavigationMap = [] 

    //for file upload
    let fileInputForUpload = document.createElement("input")
    let uploadIndex ; //holds the value of the directory to upload the file, because a person may change folders

    //entry point
    window.addEventListener("DOMContentLoaded",()=>{
        filesPageBrowser = document.querySelector(".folder-browser-page")
        browserPageHideLoading()
    })

   ///////////////////////////////////////////////////////////
   ///////////////////////////////////////////////////////////
   /////////////////////////////////////////////////////////// Page Show and Hide

    //function to show browser page
    function showBrowserFilePage(){
        filesPageBrowser.style.display = "block"
        //load files in the root directory 
        loadFiles("root")
    }

    function hideBrowserFilePage(){
        filesPageBrowser.style.display = "none"
    }

    //browser right column is loading...used when we are trying to retrive something for the right column .i.e files in that 
    //directory
    function browserPageLoading(){
        if (!document.getElementById("browserLoader").classList.contains("show"))
            document.getElementById("browserLoader").classList.add("show")
    }
    function browserPageHideLoading(){
        var loader = (document.getElementById("browserLoader"))
        loader.classList.remove("show")
    }

    ///////////////////////////////////////////////////////
    ///////////////////////////////////////////////////////
    /////////////////////////////////////////////////////// Access Control Modal

    function updateObjectAccessControl(){
        data = {
            "AUR" : document.getElementById("allowAllUsersReadAccessControl").checked ,
            "AUW" : document.getElementById("allowAllUsersWriteAccessControl").checked,
            "AKW" : document.getElementById("allowKeyUsersWriteAccessControl").checked ,
            "AKR" : document.getElementById("allowKeyUsersReadAccessControl").checked,
            "id" : fileThatHasAccessControlOpen.objectID
        }
        
        putToServer("/api/get-set-access-control/", data, function(responce) {
            if (responce !=  "200"){
                ShowWarning("Connection Error")
            }
        });
    }

    let fileThatHasAccessControlOpen ;

    function showAccessControlModal(){
        var modal = document.getElementById("accessControlModal")
        if (!modal.classList.contains("show")){
            modal.classList.add("show")
        }
        //loading
        accessControlLoading()

        data = {
            "id" : focusedFile.objectID
        }

        fileThatHasAccessControlOpen = focusedFile

        //set access control  params
        postToServer("/api/get-set-access-control/", data, function(responce) {
            var controls  = JSON.parse(responce)
            document.getElementById("allowAllUsersReadAccessControl").checked = controls['allowAllUsersRead']
            document.getElementById("allowAllUsersWriteAccessControl").checked = controls['allowAllUsersWrite']
            document.getElementById("allowKeyUsersWriteAccessControl").checked = controls['allowKeyUsersWrite']
            document.getElementById("allowKeyUsersReadAccessControl").checked = controls['allowKeyUsersRead']
        });

        //get people with the keys
        postToServer("/api/get-people-with-key/", data, function(responce) {
            hideAccessControlLoading()
            var bodyToPlace = document.getElementById('accounts-with-key')
            bodyToPlace.innerHTML = ""
            JSON.parse(responce).forEach(element => {
                element = `<!-- item frame -->
                        <div class="folder-categorizer item">
                            <div class=""><input type="checkbox" class="accountKeyCheckBox" onclick="addSelectedAccountToCheckedList('${element['user']['email']}',this)"></div>
                            <div class="categorizer-text">${element['user']['email']}</div>
                            <div class="categorizer-text hide-mobile " style="padding-left:8px;"><i class="fas fa-envelope" style="color: gray;"></i></div>
                            <div class="categorizer-text hide-mobile " style="padding-left:11px;">${element['dateObtained']}</div>
                        </div>` 
                bodyToPlace.innerHTML += element
            });

            var listInElement = document.getElementById("accounts-with-key")
            listInElement.style.height = listInElement.clientHeight + "px"
        })
    }

    function selectAllAccountsWithKeys(object){
        if (object.checked == true){
            var array = document.querySelectorAll(".accountKeyCheckBox")
            array.forEach(element => {
                if (element.checked == false){
                    element.click()
                }
            });
        }
        else{
            document.getElementById("deleteAccountKeyButton").classList.remove("show")
            selectedAccountsList = []
            var array = document.querySelectorAll(".accountKeyCheckBox")
            array.forEach(element => {
                if (element.checked == true){
                    element.click()
                }
            });
        }
    }

    function hideAccessControlModal(){
        var modal = document.getElementById("accessControlModal")
        modal.classList.remove("show")
    }

    function accessControlLoading(){
        var loadingElement = document.getElementById("accessControlLoader")
        if (!loadingElement.classList.contains("show")){
            loadingElement.classList.add("show")
        } 
    }

    function hideAccessControlLoading(){
        var loadingElement = document.getElementById("accessControlLoader")
        loadingElement.classList.remove("show")
    }
    
    function deleteSelectedKeyAccounts(){
        data = {
            "file" : fileThatHasAccessControlOpen.objectID,
            "accounts" : selectedAccountsList
        }

        postToServer("/api/remove-keys/",data, function(responce) {
        if (responce == "200") {
            document.getElementById("deleteAccountKeyButton").classList.remove("show")
            document.getElementById("allKeysSelector").checked = false
            showAccessControlModal()
        } else {
            ShowWarning("Deletion Failed")
        }
        })
    }

    //access control account selection
    let selectedAccountsList = []
    function addSelectedAccountToCheckedList(email,object){
        //show delete button
        var deleteButton = document.getElementById("deleteAccountKeyButton")

        if (object.checked == false){
            //remove element 
            removeItemOnce(selectedAccountsList,email)
            //if length is less than 1 then hide bin
            if (selectedAccountsList.length == 0){
                deleteButton.classList.remove("show")
            }

        }
        else {
            selectedAccountsList.push(email)
            if (!deleteButton.classList.contains("show")){
                deleteButton.classList.add("show")
            }
        }
    }

    function giveKeyToAccountHTTP(){
        data = {
            "account" : document.getElementById("accountKeyIDText").value,
            "file" : (fileThatHasAccessControlOpen.objectID)
        }

        postToServer("/api/give-key/", data, function(responce) {
        if (responce == "200") {
            hideAddAccountKey()
            showAccessControlModal()
        }
        else if (responce == "not found"){
            ShowWarning("Account Not Found")
        }
        else {
            ShowWarning("Request Failed")
        }
    })


    }

    function showAddAccountKey(){
        var modal = document.getElementById("accountKeyAddModal")
        if (!modal.classList.contains("show")){
            modal.classList.add("show")
            lockUploadAndDownloadModal = true
        }
    }

    function hideAddAccountKey(){
        var modal = document.getElementById("accountKeyAddModal")
        modal.classList.remove("show")
        lockUploadAndDownloadModal = false
    }

    function removeItemOnce(arr, value) {
        var index = arr.indexOf(value);
        if (index > -1) {
            arr.splice(index, 1);
        }
        return arr;
    }

    ///////////////////////////////////////////////////////
    ///////////////////////////////////////////////////////
    /////////////////////////////////////////////////////// Plain options modal 

    //options modal show entry because we need to separate between the file modal
    // file modal is for individual files, this one is to create folders, reload index e.t.c , and is different
    function showOptionsModal(event){
        if (showingFolder){
            return
        }
        hideOptionsModal()
        showBrowserOptionsModal(event)
    }
    
    //plain  options modal
    function showBrowserOptionsModal(event){
        var modal = document.getElementById("browserOptionsModal")
        //set  position on mouse position
        modal.style.left = event.clientX + "px"
        modal.style.top = event.clientY + "px"

        //if person clicks on the bottom part of the screen show the options modal on the top of 
        //the cursor , cause options wont be visible at the bottom...same for the x axis
        boundaryPointY = 0.85 * window.innerHeight
        boundaryPointX = 0.82 * window.innerWidth
        if (event.clientY > boundaryPointY){
            modal.style.top = event.clientY - modal.clientHeight + "px"
        }
        if (event.clientX > boundaryPointX){
            modal.style.left = event.clientX - modal.clientWidth+ "px"
        }

        if (!modal.classList.contains("show")){
            modal.classList.add("show")
        }
    }

    //plain options modal hide
    function hideBrowserOptionsPage(){
        var modal = document.getElementById("browserOptionsModal")
        modal.classList.remove("show")
    }

    //new folder option
    function plainMenuNewFolderClick(){
        showNameFolderModal()
    }

    //shows the modal to name a folder once the user clicks "New Folder" in the options modal
    function showNameFolderModal(){
        hideRenameModal()
        var modal = document.getElementById("nameFolderModal")
        if (!modal.classList.contains("show")){
            modal.classList.add("show")    
            lockUploadAndDownloadModal = true
        }
        
    }


    function hideNameFolderModal(){
        var modal = document.getElementById("nameFolderModal")
        if (modal.classList.contains("show")){
            modal.classList.remove("show")
            lockUploadAndDownloadModal = false
        }
        
    }

    //once user has name modal, send the request to the Server 
    function createNewFolder(){
    name = document.getElementById("newFolderName").value
    var parentID = "root"
    if (browserNavigationMap.length > 0){
        parentID = browserNavigationMap[browserNavigationMap.length - 1].folderID
    }
    data = {
        "folderName" : name,
        "projectName" : localStorage.getItem("working-project"),
        "parentID" : parentID,
    } 

    postToServer("/api/new-folder/",data, function(responce) {
        if (responce == "200") {
            hideNameFolderModal()
            reloadFiles()
        }
        else if (responce == "1701"){
            ShowWarning("Repeated Folder Name")
        } 
        else {
            ShowWarning("Folder Creation Failed")
        }
    })

    }

    ///////////////////////////////////////////////////////
    ///////////////////////////////////////////////////////
    /////////////////////////////////////////////////////// File and Folder options modal

    //shows options modal after file or folder has been right clicked
    function handleRightClick(event,objectID,objectType,objectName,objectSize,objectCreated,object){
        if (selectedObject != object){
            removeAllSelected()
            indexObjectSelected = false
        }
        if (!indexObjectSelected){
            return false
        }
        //showing folder 
        showingFolder = true
        //show options moadal
        var optionsModal = document.getElementById("fileOptionsModal")

        //set  position on mouse position
        optionsModal.style.left = event.clientX + "px"
        optionsModal.style.top = event.clientY + "px"

        //if person clicks on the bottom part of the screen show the options modal on the top of 
        //the cursor , cause options wont be visible at the bottom...same for the x axis
        boundaryPointY = 0.85 * window.innerHeight
        boundaryPointX = 0.82 * window.innerWidth
        if (event.clientY > boundaryPointY){
            optionsModal.style.top = event.clientY - optionsModal.clientHeight + "px"
        }
        if (event.clientX > boundaryPointX){
            optionsModal.style.left = event.clientX - optionsModal.clientWidth+ "px"
        }

        //set new focused file 
        focusedFile = new IndexObject(objectID,objectType,objectName,objectSize,objectCreated)


        //show modal 
        if (!optionsModal.classList.contains("show")){
            hideBrowserOptionsPage()
            optionsModal.classList.add("show")
        }
        return false
    }

    //hide file options modal
    function hideOptionsModal(){
        var optionsModal = document.getElementById("fileOptionsModal")
        optionsModal.classList.remove("show")
        showingFolder = false
    }

    //open file option 
    function menuModalOpenClick(){
    //open file or folder through loading the index object 
    loadIndexObject(event,focusedFile.objectType,focusedFile.objectID,focusedFile.objectName)
    hideOptionsModal()
    }

    //delete file option
    function menuModalDeleteClick(){
        //file to delete json
        data = {
            "id" : focusedFile.objectID
        }
        //delete file via API
        postToServer("/api/delete/", data, function(responce) {
        if (responce == "200") {
            hideOptionsModal()
            reloadFiles()
        } else {
            ShowWarning("Something Went Wrong")
        }
    })
    }


    //show the rename modal 
    let objectToRename ;
    function showRenameModal(){
        lockUploadAndDownloadModal = true
        hideNameFolderModal()
        var modal = document.getElementById("renameFolderModal")
        if (!modal.classList.contains("show")){
            modal.classList.add("show")
        }
        //set the textbox to the current filename 
        var renameInput = document.getElementById("renameText")
        renameInput.value =  (focusedFile.objectName)
        renameInput.focus()
        renameInput.select()

        //keep selected file local 
        objectToRename = focusedFile
    }

    //send rename request 
    function sendRenameRequest(){
        var renameInput = document.getElementById("renameText")
        //send rename request
        data = {
            "id" : objectToRename.objectID,
            "name" : renameInput.value
        }
        postToServer("/api/rename-object/", data, function(responce) {
            if (responce == "200") {
                hideRenameModal()
                reloadFiles()
            } else {
                ShowWarning("Rename Failed")
            }
        })
    }

    //show the rename modal 
    function hideRenameModal(){
        lockUploadAndDownloadModal = false
        var modal = document.getElementById("renameFolderModal")
        modal.classList.remove("show") 
    }
    

    ///////////////////////////////////////////////////////
    ///////////////////////////////////////////////////////
    /////////////////////////////////////////////////////// Functions for files 
    
    //function to load index, this is where files or folders that are clicked are sent
    function loadIndexObject(event,objectType,folderRef,folderName){
        if (objectType == "FD"){

            var objectToMap  = new dirObject(folderRef,folderName)
            objectToMap.folderRef = folderRef
            
            //map 
            mapCurrent(objectToMap)
            loadFiles(folderRef)
        }
        else {
            ///if the file download the file 
            var fileRef = folderRef
            var fileName = folderName
            
            ///download file 
            data = {
                "id" : folderRef
            }
            downloadFile(data,fileName)
        }
    }

    //function to load files for a given folderID, to the files body
    function loadFiles(folderID){
        browserPageLoading()
        details = {
            "projectName" : localStorage.getItem("working-project"),
            "folderID" :folderID
        }
        postToServer("/console/get-folder", details, function(responce) {
        if (responce == "500") {
            ShowWarning("Connection Problem")
        } else {
            browserPageHideLoading()
            document.getElementById("browserFilesContent").innerHTML = responce
        }
        })
    }

    //reload current directory
    function reloadFiles(){
        //reload data with the current window
        var currentDirectory;
        if (browserNavigationMap.length > 0){
            currentDirectory = browserNavigationMap[browserNavigationMap.length - 1].folderID
        }
        else {
            currentDirectory = "root"
        }
        loadFiles(currentDirectory)
    }
    
    //function to map index given a new dir object 
    function mapCurrent(dirObject){
        browserNavigationMap.push(dirObject)
        //add to ui
        if (dirObject.folderName != 'root'){
            var mapPosition = browserNavigationMap.length
            uiElement = `<!--directory --><span class="slash">/</span><span class="directory-name" onclick="goBackward(${mapPosition})" >${dirObject.folderName}</span>`
            document.getElementById("dirMapper").innerHTML += uiElement
        }
    }

    //function to upload a file, but does not post to serverbut calls the modal to set access control
    function uploadFile(){
        fileInputForUpload.type = "file"
        fileInputForUpload.click()
        fileInputForUpload.id = "fileUploads"
        fileInputForUpload.addEventListener("change",function(){
            showUploads()
            document.getElementById("uploadSize").innerHTML = "Size : " + fileInputForUpload.files[0].size
            document.getElementById("uploadName").innerHTML = "Name : " + fileInputForUpload.files[0].name
        })
        //set working index
        if (browserNavigationMap.length == 0){
            uploadIndex = "root"
        }
        else {
            uploadIndex = browserNavigationMap[browserNavigationMap.length - 1].folderID
        }
    }

    //function to send the file to the server
    let request = new XMLHttpRequest();
    function sendFile(object){
        //show upload bar 
        var uploadBar = document.getElementById("upload-bar")

        if (object.innerHTML != "Cancel"){
            object.innerHTML = "Cancel"
        }
        else{
            uploadBar.classList.remove("show")
            request.abort()
            object.innerHTML = "Upload"
            return
        }

        try{
            uploadBar.classList.add("show")
            //form data
            var file = fileInputForUpload.files[0];
            var formData = new FormData();
            formData.append("file",file)
            formData.append("name",fileInputForUpload.files[0].name)
            formData.append("size",fileInputForUpload.files[0].size)
            formData.append("project",localStorage.getItem("working-project"))
            //access control 
            formData.append("parent",uploadIndex)
            formData.append("allowAllUsersWrite", document.getElementById("allowAllUsersWrite").checked)
            formData.append("allowAllUsersRead",document.getElementById("allowAllUsersRead").checked)
            formData.append("allowKeyUsersRead",document.getElementById("allowKeyUsersRead").checked)
            formData.append("allowKeyUsersWrite",document.getElementById("allowKeyUsersWrite").checked)

            //show progress bar
            if (!uploadBar.classList.contains("show")){
                uploadBar.classList.add("show")
            }
        
            //xml http 

            request.open('POST', '/console/upload-file'); 
            // upload progress event
            request.onreadystatechange = function() {
            var a;
                if (request.readyState === 4 && request.status === 200) {
                    if (request.response == "200"){
                        hideUploads()
                        uploadBar.classList.remove("show")
                        ShowSuccess("Upload Completed")

                        //reload data with the current window
                        reloadFiles()
                    }
                    else if (request.response == "1702") {
                        ShowWarning("Bad File Name")
                        uploadBar.classList.remove("show")
                    }
                    else if (request.response == "1703"){
                        ShowWarning("Repeated File Name")
                        uploadBar.classList.remove("show")
                    }
                }
            };

            request.upload.addEventListener('progress', function(e) {
                // upload progress as percentage
                let percent_completed = (e.loaded / e.total)*100;
                document.getElementById("upload-progress").style.width = percent_completed +"%";
            });
            // send POST request to server
            request.send(formData);
        }
        catch(err){
            ShowWarning("No File Selected")
        }
    }

    //goes back to previous directory
    function goBackward(n){
        browserNavigationMap = browserNavigationMap.slice(0,n)
        loadFiles(browserNavigationMap[browserNavigationMap.length - 1].folderRef)
        var dirMapper = document.getElementById("dirMapper").innerHTML = ""
        for (var i=0;i != browserNavigationMap.length;i++){
            uiElement = ` <!--directory --><span class="slash">/</span><span class="directory-name" onclick="goBackward(${i + 1})" >${browserNavigationMap[i].folderName}</span>`
            document.getElementById("dirMapper").innerHTML += uiElement
        }
    }

    //goes to home directory
    function goHome(){
        var dirMapper = document.getElementById("dirMapper").innerHTML = " "
        browserNavigationMap = []
        loadFiles('root')
    }


    function showFilesBin(){
        var bin = document.querySelector(".delete-button-files")
        if (!bin.classList.contains("show")){
            bin.classList.add("show")
        }
    }


    function hideFilesBin(){
        var bin = document.querySelector(".delete-button-files")
        bin.classList.remove("show")
    }


    function selectUnselectAllFiles(object){
        if (object.checked){
            array = document.querySelectorAll(".filesCheckboxBox")
            array.forEach(element => {
                if (element.checked == false){
                    element.click()
                }
            });
        }
        else {
            array = document.querySelectorAll(".filesCheckboxBox")
            array.forEach(element => {
                if (element.checked){
                    element.click()
                }
            });
        }
    }

    let markedFiles = []
    function markFile(id,object){
        if (object.checked){
            markedFiles.push(id)
            showFilesBin()
        }
        else {
            removeItemOnce(markedFiles,id)
            if (markedFiles.length == 0){
                hideFilesBin()
            }
        }
    }


    function deleteSelectedFiles(){
        markedFiles.forEach(element => {
            data = {
                "id" : element 
            }
            //delete file via API
            postToServer("/api/delete/", data, function(responce) {
            if (responce == "200") {
                hideOptionsModal()
                reloadFiles()
                hideFilesBin()
                document.getElementById("selectUnselectAllFiles").checked = false
            } 
            });
        })
    }

    //////////////////////////////////////////////////////
    //////////////////////////////////////////////////////
    ////////////////////////////////////////////////////// Global functions
    
    //prevents chrome's properties modal from showing up
    window.oncontextmenu= function(){
        return false
    }

    //for hiding all modals on page click
    ///seems repeated to me


    function removeAllSelected(){
        var AllObjects = document.querySelectorAll(".folder-categorizer")
        AllObjects.forEach(element => {
            element.classList.remove("selected")
        });
    }

    let selectedObject ;
    function handleSingleClick(object) { 
        removeAllSelected()
        selectedObject = object
        if (!object.classList.contains("selected")){
            object.classList.add("selected")
        }
        indexObjectSelected = true
    }   


    function removeAnyModal(){
        hideOptionsModal()
        hideBrowserOptionsPage()
    }
</script>