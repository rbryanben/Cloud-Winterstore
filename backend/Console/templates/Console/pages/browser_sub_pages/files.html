{% load static %}
<style>
    /* file browser page */
    .folder-browser-page {
        display: none;
    }

    .browserFilesContent {
        overflow-y: scroll;
    }

    .folder-toolbar-navigator>i {
        color: gray;
    }
    .folder-toolbar-navigator>span{
        color: gray;
    }
    .slash{
        margin-left: 5px;
        margin-right: 5px;
        color: gray;
    }
    .directory-name:hover{
        text-decoration: underline;
    }

    .slash{
        text-decoration: none;
    }

    .upload-file{
        position: absolute;
        top: 15px;
        right: 30px;
        color: gray;
        transition: all 0.2s ease-in;
    }

    .upload-file:hover{
        transform: scale(1.1);
    }

    .folder-categorizer {
        margin-top: 30px;
        display: grid;
        grid-template-columns: 10% 40% 20% 40%;
    }


    .categorizer-text {
        margin-top: 2px;
        font-size: small;
        color: gray;
    }

    .separator {
        border-bottom: solid 1px rgba(235, 235, 235, 0.685);
        margin-left: -20px;
        margin-top: 20px;
    }

    .folder-browser-page {
        margin-right: 1.5%;
    }

    .folder-categorizer.item{
        
        margin-top: 0;
        margin-left: -20px;
        padding-left: 20px;
        padding-top: 10px;
        padding-bottom: 10px;
        border-bottom: solid 1px rgba(235, 235, 235, 0.685);
    }

    .categorizer-text>i{
        margin-right: 10px;
        color: rgb(108, 219, 177);
    }

    .folder-categorizer.item:hover{
        background-color: rgba(142, 178, 226, 0.137);
    }

    .file-menu-modal {
        background-color: white;
        height: auto;
        width: 220px;
        z-index: 101;
        position: fixed;
        top: 190px;
        left: 400px;
        border-radius: 6px;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
    }

    .file-menu-modal-item{
        font-size: small;
        color: gray;
        padding: 10px;
        padding-left: 20px;
    }

    .file-menu-modal-item:hover{
        background-color: rgba(243, 243, 243, 0.795);
    }

    .separator {
        margin:0;
    }

    @media only screen and (max-width: 600px) {
        .folder-categorizer.item {
            grid-template-columns: 20% 90% ;
        }

        .folder-categorizer {
            grid-template-columns: 20% 90% ;
        }

        .hide-mobile {
            display: none;
        }
    }

</style>

<div class="folder-browser-page">  
    <div id="browserLoader" class="pageLoader" style="transform: scale(0.2);">
         <div class="loader-console"></div>
    </div>
    <div class="folder-toolbar">
        <div  class="folder-toolbar-navigator">
             <i class="fas fa-home" onclick="goHome()"></i><span id="dirMapper"><!-- mapping elements here --> </span>
        </div>
        <!-- upload-->
        <div class="upload-file">
             <i class="fas fa-upload" onclick="uploadFile()"></i>
        </div>
        <!-- folders-->
        <div class="folder-categorizer">
            <div class=""><input type="checkbox"></div>
            <div class="categorizer-text">Name</div>
            <div class="categorizer-text hide-mobile ">Size</div>
            <div class="categorizer-text hide-mobile ">Modified</div>
        </div>
        <!-- separator -->
        <div class="separator"></div>
        <!-- files come in here-->
        <div id="browserFilesContent">
    
        </div>

        <!-- file menu modal-->
        <div class="file-menu-modal" id="fileOptionsModal">
            <div class="file-menu-modal-item">
                Open
            </div>
            <div class="file-menu-modal-item">
                Rename
            </div>
            <div class="file-menu-modal-item">
                Delete
            </div>
            <div class="separator"></div>
            <div class="file-menu-modal-item">
                Access Control
            </div>
        </div>
     </div>
</div>

<script>
    var filesPageBrowser 

    window.addEventListener("DOMContentLoaded",()=>{
        filesPageBrowser = document.querySelector(".folder-browser-page")
        browserPageHideLoading()
    })

    function showBrowserFilePage(){
        filesPageBrowser.style.display = "block"
        //load files in the root directory 
        loadFiles("root")
    }

    //page
    function loadFiles(folderID){
        browserPageLoading()
        details = {
            "projectName" : localStorage.getItem("working-project"),
            "folderID" :folderID
        }
        postToServer("/console/get-folder", details, function(responce) {
        if (responce == "500") {
            alert("problem")
        } else {
            browserPageHideLoading()
            document.getElementById("browserFilesContent").innerHTML = responce
        }
    })
    }

    function hideBrowserFilePage(){
        filesPageBrowser.style.display = "none"
    }

    //document
    function browserPageHideLoading(){
        var loader = (document.getElementById("browserLoader"))
        loader.classList.remove("show")
    }

    
    function browserPageLoading(){
        if (!document.getElementById("browserLoader").classList.contains("show"))
            document.getElementById("browserLoader").classList.add("show")
    }
     
    window.oncontextmenu= function(){
        return false
    }

    /// browser file objects
    function handleRightClick(event){
        //show options moadal
        var optionsModal = document.getElementById("fileOptionsModal")
        //set  position on mouse position
        optionsModal.style.left = event.clientX + "px"
        optionsModal.style.top = event.clientY + "px"
        return false
    }

    function loadIndexObject(event,objectType,folderRef,folderName){
        if (objectType == "FD"){

            var objectToMap  = new dirObject(folderRef,folderName)
            objectToMap.folderRef = folderRef
            
            //map 
            mapCurrent(objectToMap)
            loadFiles(folderRef)
        }
        else {
            ///if the file download the file 
            var fileRef = folderRef
            var fileName = folderName
            
            ///download file 
            data = {
                "id" : folderRef
            }
            downloadFile(data,fileName)
        }
    }

    

    ///browser navigation
    let browserNavigationMap = [] 

    let dirObject = class {
        constructor(folderID,name){
            this.folderID = folderID
            this.folderName = name
        }
    }

    function mapCurrent(dirObject){
        browserNavigationMap.push(dirObject)
        //add to ui
        if (dirObject.folderName != 'root'){
            var mapPosition = browserNavigationMap.length
            uiElement = `<!--directory --><span class="slash">/</span><span class="directory-name" onclick="goBackward(${mapPosition})" >${dirObject.folderName}</span>`
            document.getElementById("dirMapper").innerHTML += uiElement
        }
    }

    let fileInputForUpload = document.createElement("input")
    let uploadIndex ;
    function uploadFile(){
        fileInputForUpload.type = "file"
        fileInputForUpload.click()
        fileInputForUpload.id = "fileUploads"
        fileInputForUpload.addEventListener("change",function(){
            showUploads()
            console.warn(fileInputForUpload.files[0].name)
            document.getElementById("uploadSize").innerHTML = "Size : " + fileInputForUpload.files[0].size
            document.getElementById("uploadName").innerHTML = "Name : " + fileInputForUpload.files[0].name
        })
        //set working index
        if (browserNavigationMap.length == 0){
            uploadIndex = "root"
        }
        else {
            uploadIndex = browserNavigationMap[browserNavigationMap.length - 1].folderID
        }
    }

    function sendFile(){
        try{
            //show upload bar 
            var uploadBar = document.getElementById("upload-bar")
            

            //form data
            var file = fileInputForUpload.files[0];
            var formData = new FormData();
            formData.append("file",file)
            formData.append("name",fileInputForUpload.files[0].name)
            formData.append("size",fileInputForUpload.files[0].size)
            formData.append("project",localStorage.getItem("working-project"))
            //access control 
            formData.append("parent",uploadIndex)
            formData.append("allowAllUsersWrite", document.getElementById("allowAllUsersWrite").checked)
            formData.append("allowAllUsersRead",document.getElementById("allowAllUsersRead").checked)
            formData.append("allowKeyUsersRead",document.getElementById("allowKeyUsersRead").checked)
            formData.append("allowKeyUsersWrite",document.getElementById("allowKeyUsersWrite").checked)

            //show progress bar
            if (!uploadBar.classList.contains("show")){
                uploadBar.classList.add("show")
            }
        
            //xml http 
            var request = new XMLHttpRequest();
            request.open('POST', '/console/upload-file'); 
            // upload progress event
            request.upload.addEventListener('progress', function(e) {
                // upload progress as percentage
                let percent_completed = (e.loaded / e.total)*100;
                document.getElementById("upload-progress").style.width = percent_completed +"%";
                
                if (percent_completed >= 100){
                    setTimeout(()=>{
                        hideUploads()
                        uploadBar.classList.remove("show")
                        ShowSuccess("Upload Completed")

                        //reload data with the current window
                        var currentDirectory;
                        if (browserNavigationMap.length > 0){
                            currentDirectory = browserNavigationMap[browserNavigationMap.length - 1].folderID
                        }
                        else {
                            currentDirectory = "root"
                        }
                        loadFiles(currentDirectory)
                    },1000)  
                }
            });
            // send POST request to server
            request.send(formData);
        }
        catch(err){
            ShowWarning("No File Selected")
        }
    }


    function goBackward(n){
        browserNavigationMap = browserNavigationMap.slice(0,n)
        loadFiles(browserNavigationMap[browserNavigationMap.length - 1].folderRef)
        var dirMapper = document.getElementById("dirMapper").innerHTML = ""
        for (var i=0;i != browserNavigationMap.length;i++){
            uiElement = ` <!--directory --><span class="slash">/</span><span class="directory-name" onclick="goBackward(${i + 1})" >${browserNavigationMap[i].folderName}</span>`
            document.getElementById("dirMapper").innerHTML += uiElement
        }
    }


    function goHome(){
        var dirMapper = document.getElementById("dirMapper").innerHTML = " "
        browserNavigationMap = []
        loadFiles('root')
    }

</script>


  